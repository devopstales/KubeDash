{% extends "base2.html.j2" %}

{% block topmenu %}
<ul class="header-nav d-lg-flex m-3">
    <div class="container-fluid px-4">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb my-0">
          <li class="breadcrumb-item"><span>Workloads</span></li>
          <li class="breadcrumb-item"><span>Pods</span></li>
          <li class="breadcrumb-item">
            <div class="d-flex">
              <form action="/workload/pods/data" method="POST" class="form-post">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="ns_select" value="{{ session['ns_select'] }}" />
                <input type="hidden" name="po_name" value="{{ po_name }}" />
                <a href="javascript:;" onclick="parentNode.submit();">{{ po_name }}</a>
              </form>
            </div>
          </li>
          <li class="breadcrumb-item active"><span>Shell</span></li>
        </ol>
      </nav>
    </div>
</ul>
<ul class="header-nav ms-auto"></ul>
<ul class="header-nav d-lg-flex">
{% include "segments/topmenu.html.j2" %}
{% endblock %}

{% block content %}
<div class="card">
    <div id="filter-menu" class="card-header">
      <div class="row justify-content-between">
        <div class="col-3">
          <span>Status: <span id="status">connecting...</span></span>
        </div>
        <form name="add" method="POST" class="col-3">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
          <input type="hidden" name="po_name" value="{{ po_name }}">
          <div class="input-group">
              <select name= "container_select" class="form-select" id="containers" aria-label="Select Container">
                {% for container in pod_containers %}
                {% if container == container_select %}
                <option value="{{ container }}" selected>{{ container }}</option>
                {% else %}
                <option value="{{ container }}">{{ container }}</option>
                {% endif %}
                {% endfor %}
              </select>
              <button type="submit" class="btn btn-primary" type="button">Submit</button>
          </div>
        </form>
      </div>
    </div>
    <div id="terminal" class="card-body terminalBody"></div>
</div>
{% endblock %}

{% block add_head_css %}
{% include "segments/datatable_snippet.html.j2" %}
{% include "segments/socket_snippet.html.j2" %}
{% endblock %}

{% block add_tail_js %}
    <script>
        const term = new Terminal({
          cursorBlink: true,
          macOptionIsMeta: true,
          scrollback: true,
        });

        term.attachCustomKeyEventHandler(customKeyEventHandler);
        // https://github.com/xtermjs/xterm.js/issues/2941
        const fit = new FitAddon.FitAddon();
        term.loadAddon(fit);
        term.loadAddon(new WebLinksAddon.WebLinksAddon());
        term.loadAddon(new SearchAddon.SearchAddon());

        term.open(document.getElementById('terminal'));
        fit.fit();

        term.onKey(e => {
            socket.emit("exec-input", {"input": e.key})
        });

        const socket = io.connect('/exec');
        const status = document.getElementById("status");

        socket.on("connect", () => {
          socket.send("{{ po_name }}", "{{ container_select }}");
          term.reset();
          status.innerHTML = '<span class="connected">connected</span>';
        });

        socket.on("response", function(msg){
            term.write(msg.output)
        });

        socket.on("disconnect", () => {
          status.innerHTML =
            '<span class="disconnected">disconnected</span>';
        });

        /**
        * Handle copy and paste events
        */
        function customKeyEventHandler(e) {
          if (e.type !== "keydown") {
            return true;
          }
          if (e.ctrlKey && e.shiftKey) {
            const key = e.key.toLowerCase();
            if (key === "v") {
              // ctrl+shift+v: paste whatever is in the clipboard
              navigator.clipboard.readText().then((toPaste) => {
                term.writeText(toPaste);
              });
              return false;
            } else if (key === "c" || key === "x") {
              // ctrl+shift+x: copy whatever is highlighted to clipboard

              // 'x' is used as an alternate to 'c' because ctrl+c is taken
              // by the terminal (SIGINT) and ctrl+shift+c is taken by the browser
              // (open devtools).
              // I'm not aware of ctrl+shift+x being used by anything in the terminal
              // or browser
              const toCopy = term.getSelection();
              navigator.clipboard.writeText(toCopy);
              term.focus();
              return false;
            }
          }
          return true;
        }
    </script>
{% endblock %}