<div class="card shadow mb-4">
    <div class="card-header py-3 d-flex justify-content-between align-items-center">
        <h6 class="m-0 font-weight-bold text-primary">Flux Object Dependencies</h6>
        <div>
            <button type="button" class="btn btn-sm btn-secondary" onclick="fitGraph()" title="Fit to view">
                <i class="fa fa-expand"></i>
            </button>
            <button type="button" class="btn btn-sm btn-secondary" onclick="resetLayout()" title="Reset layout">
                <i class="fa fa-redo"></i>
            </button>
        </div>
    </div>
    <div class="card-body p-0">
        <!-- Graph Container with Tooltip -->
        <div id="flux-graph-wrapper" style="position: relative; height: 500px; width: 100%;">
            <div id="flux-graph-container" style="height: 100%; width: 100%;"></div>
            <!-- Node Tooltip (inside graph wrapper) -->
            <div id="node-tooltip" style="display: none; position: absolute; z-index: 1000; max-width: 350px; pointer-events: none;"></div>
        </div>
        
        <!-- Legend -->
        <div class="p-3 border-top">
            <div class="d-flex flex-wrap align-items-center gap-3">
                <small class="text-muted">
                    <strong>Legend:</strong>
                    <span class="ms-2"><span style="display:inline-block;width:12px;height:12px;background:#6f42c1;border-radius:2px;vertical-align:middle;"></span> GitRepository</span>
                    <span class="ms-2"><span style="display:inline-block;width:12px;height:12px;background:#0d6efd;border-radius:2px;vertical-align:middle;"></span> HelmRepository</span>
                    <span class="ms-2"><span style="display:inline-block;width:12px;height:12px;background:#20c997;border-radius:2px;vertical-align:middle;"></span> OCIRepository</span>
                    <span class="ms-2"><span style="display:inline-block;width:12px;height:12px;background:#198754;border-radius:2px;vertical-align:middle;"></span> Kustomization</span>
                    <span class="ms-2"><span style="display:inline-block;width:12px;height:12px;background:#dc3545;border-radius:2px;vertical-align:middle;"></span> HelmRelease</span>
                </small>
                <small class="text-muted border-start ps-3">
                    <strong>Status:</strong>
                    <span class="ms-2" style="color:#198754;">‚óè Ready</span>
                    <span class="ms-2" style="color:#dc3545;">‚óè Error</span>
                    <span class="ms-2" style="color:#6c757d;">‚óè Suspended</span>
                </small>
                <small class="text-muted border-start ps-3">
                    <i class="fa fa-mouse-pointer"></i> <strong>Hover</strong> for info bubble | <i class="fa fa-hand-pointer"></i> <strong>Click</strong> to open details
                </small>
            </div>
        </div>
    </div>
</div>

<!-- Cytoscape.js -->
<script src="https://unpkg.com/cytoscape@3.28.1/dist/cytoscape.min.js"></script>
<script src="https://unpkg.com/dagre@0.8.5/dist/dagre.min.js"></script>
<script src="https://unpkg.com/cytoscape-dagre@2.5.0/cytoscape-dagre.js"></script>

<script>
var cy = null;
var graphData = {{ graph_data | safe }};
var tooltip = null;

// Theme detection
function isDarkMode() {
    return document.documentElement.getAttribute('data-coreui-theme') === 'dark';
}

function getThemeColors() {
    var dark = isDarkMode();
    return {
        background: dark ? '#1e1e1e' : '#f8f9fa',
        textColor: dark ? '#e4e4e4' : '#212529',
        textOutline: dark ? '#1e1e1e' : '#fff',
        edgeColor: dark ? '#6c757d' : '#adb5bd',
        tooltipBg: dark ? '#2d2d2d' : '#ffffff',
        tooltipBorder: dark ? '#444' : '#dee2e6',
        tooltipText: dark ? '#e4e4e4' : '#212529'
    };
}

function updateGraphTheme() {
    var colors = getThemeColors();
    var wrapper = document.getElementById('flux-graph-wrapper');
    if (wrapper) {
        wrapper.style.background = colors.background;
    }
    if (cy) {
        cy.style()
            .selector('node')
            .style({
                'color': colors.textColor,
                'text-outline-color': colors.textOutline
            })
            .selector('edge')
            .style({
                'line-color': colors.edgeColor,
                'target-arrow-color': colors.edgeColor,
                'color': colors.edgeColor
            })
            .update();
    }
}

document.addEventListener('DOMContentLoaded', function() {
    tooltip = document.getElementById('node-tooltip');
    initializeGraph();
    
    // Listen for theme changes
    var observer = new MutationObserver(function() {
        updateGraphTheme();
    });
    observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-coreui-theme'] });
});

function initializeGraph() {
    var elements = [];
    var colors = getThemeColors();
    
    // Set initial background on wrapper
    var wrapper = document.getElementById('flux-graph-wrapper');
    var container = document.getElementById('flux-graph-container');
    if (wrapper) {
        wrapper.style.background = colors.background;
    }
    
    if (graphData.nodes) {
        graphData.nodes.forEach(function(node) {
            elements.push({ group: 'nodes', data: node.data });
        });
    }
    
    if (graphData.edges) {
        graphData.edges.forEach(function(edge) {
            elements.push({ group: 'edges', data: edge.data });
        });
    }
    
    cy = cytoscape({
        container: container,
        elements: elements,
        style: [
            {
                selector: 'node',
                style: {
                    'background-color': 'data(color)',
                    'label': 'data(label)',
                    'color': colors.textColor,
                    'text-outline-color': colors.textOutline,
                    'text-outline-width': 2,
                    'font-size': '11px',
                    'text-valign': 'bottom',
                    'text-margin-y': 6,
                    'width': 35,
                    'height': 35,
                    'border-width': 2,
                    'border-color': function(ele) {
                        var status = ele.data('status');
                        if (status === 'Ready') return '#198754';
                        if (status === 'Not Ready') return '#dc3545';
                        if (status === 'Suspended') return '#6c757d';
                        return '#ffc107';
                    }
                }
            },
            {
                selector: 'node:selected',
                style: {
                    'border-width': 4,
                    'border-color': '#0d6efd'
                }
            },
            {
                selector: 'node:active',
                style: {
                    'overlay-opacity': 0.2,
                    'overlay-color': '#326ce5'
                }
            },
            {
                selector: 'edge',
                style: {
                    'width': 2,
                    'line-color': colors.edgeColor,
                    'target-arrow-color': colors.edgeColor,
                    'target-arrow-shape': 'triangle',
                    'curve-style': 'bezier',
                    'label': 'data(label)',
                    'font-size': '9px',
                    'color': colors.edgeColor,
                    'text-rotation': 'autorotate',
                    'text-margin-y': -8
                }
            },
            {
                selector: 'edge[lineStyle = "dashed"]',
                style: {
                    'line-style': 'dashed'
                }
            }
        ],
        layout: {
            name: 'dagre',
            rankDir: 'LR',
            nodeSep: 60,
            rankSep: 100,
            padding: 20
        },
        minZoom: 0.3,
        maxZoom: 2,
        wheelSensitivity: 0.3
    });
    
    cy.on('tap', 'node', function(evt) {
        var node = evt.target;
        var kind = node.data('kind');
        var namespace = node.data('namespace');
        var label = node.data('label');
        window.location.href = '/plugins/flux/detail/' + kind + '/' + namespace + '/' + label;
    });
    
    cy.on('mouseover', 'node', function(evt) {
        document.body.style.cursor = 'pointer';
        showTooltip(evt);
    });
    
    cy.on('mouseout', 'node', function() {
        document.body.style.cursor = 'default';
        hideTooltip();
    });
    
    cy.on('mousemove', 'node', function(evt) {
        moveTooltip(evt);
    });
    
    cy.fit(30);
}

function showTooltip(evt) {
    var node = evt.target;
    var data = node.data();
    var colors = getThemeColors();
    
    // Build tooltip content
    var statusBadge = '';
    if (data.status === 'Ready') {
        statusBadge = '<span style="background:#198754;color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;">‚úì Ready</span>';
    } else if (data.status === 'Suspended') {
        statusBadge = '<span style="background:#6c757d;color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;">‚è∏ Suspended</span>';
    } else if (data.status === 'Progressing') {
        statusBadge = '<span style="background:#0dcaf0;color:#000;padding:2px 8px;border-radius:4px;font-size:11px;">‚ü≥ Progressing</span>';
    } else {
        statusBadge = '<span style="background:#dc3545;color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;">‚úó Not Ready</span>';
    }
    
    var html = '<div style="background:' + colors.tooltipBg + ';border:1px solid ' + colors.tooltipBorder + ';border-radius:8px;padding:12px 14px;box-shadow:0 4px 16px rgba(0,0,0,0.2);color:' + colors.tooltipText + ';min-width:280px;">';
    
    // Header with kind badge
    var kindColor = data.color || '#6c757d';
    html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid ' + colors.tooltipBorder + ';">';
    html += '<span style="background:' + kindColor + ';color:#fff;padding:2px 8px;border-radius:4px;font-size:10px;text-transform:uppercase;">' + (data.kind || '-') + '</span>';
    html += '<span style="font-weight:bold;font-size:14px;">' + data.label + '</span>';
    html += '</div>';
    
    html += '<table style="font-size:12px;width:100%;border-collapse:collapse;">';
    html += '<tr><td style="padding:3px 10px 3px 0;color:#6c757d;width:90px;">Namespace:</td><td style="padding:3px 0;"><code style="background:' + (colors.background === '#1e1e1e' ? '#333' : '#f1f3f5') + ';padding:1px 4px;border-radius:3px;font-size:11px;">' + (data.namespace || '-') + '</code></td></tr>';
    html += '<tr><td style="padding:3px 10px 3px 0;color:#6c757d;">Status:</td><td style="padding:3px 0;">' + statusBadge + '</td></tr>';
    
    // Show URL/Source info based on kind
    if (data.url) {
        var urlLabel = 'Source:';
        if (data.kind === 'GitRepository' || data.kind === 'HelmRepository' || data.kind === 'OCIRepository') {
            urlLabel = 'URL:';
        } else if (data.kind === 'Provider') {
            urlLabel = 'Type:';
        }
        var urlDisplay = data.url.length > 45 ? data.url.substring(0, 45) + '...' : data.url;
        html += '<tr><td style="padding:3px 10px 3px 0;color:#6c757d;vertical-align:top;">' + urlLabel + '</td><td style="padding:3px 0;word-break:break-all;font-size:11px;">' + urlDisplay + '</td></tr>';
    }
    
    // Branch/Tag for repos
    if (data.branch) {
        html += '<tr><td style="padding:3px 10px 3px 0;color:#6c757d;">Branch/Tag:</td><td style="padding:3px 0;"><code style="background:' + (colors.background === '#1e1e1e' ? '#333' : '#f1f3f5') + ';padding:1px 4px;border-radius:3px;font-size:11px;">' + data.branch + '</code></td></tr>';
    }
    
    // Chart name for HelmRelease
    if (data.chart) {
        html += '<tr><td style="padding:3px 10px 3px 0;color:#6c757d;">Chart:</td><td style="padding:3px 0;font-weight:500;">' + data.chart + (data.path ? ' <span style="color:#6c757d;">v' + data.path + '</span>' : '') + '</td></tr>';
    }
    
    // Path for Kustomization
    if (data.path && data.kind === 'Kustomization') {
        html += '<tr><td style="padding:3px 10px 3px 0;color:#6c757d;">Path:</td><td style="padding:3px 0;font-family:monospace;font-size:11px;">' + data.path + '</td></tr>';
    }
    
    // Interval
    if (data.interval) {
        html += '<tr><td style="padding:3px 10px 3px 0;color:#6c757d;">Interval:</td><td style="padding:3px 0;">' + data.interval + '</td></tr>';
    }
    
    // Revision
    if (data.revision) {
        var rev = data.revision.length > 35 ? data.revision.substring(0, 35) + '...' : data.revision;
        html += '<tr><td style="padding:3px 10px 3px 0;color:#6c757d;">Revision:</td><td style="padding:3px 0;font-family:monospace;font-size:10px;">' + rev + '</td></tr>';
    }
    
    // Message (if not ready)
    if (data.message && data.status !== 'Ready') {
        var msg = data.message.length > 80 ? data.message.substring(0, 80) + '...' : data.message;
        html += '<tr><td style="padding:3px 10px 3px 0;color:#6c757d;vertical-align:top;">Message:</td><td style="padding:3px 0;word-break:break-word;font-size:11px;color:' + (data.status === 'Not Ready' ? '#dc3545' : colors.tooltipText) + ';">' + msg + '</td></tr>';
    }
    
    html += '</table>';
    
    // Click hint with icon
    html += '<div style="font-size:10px;color:#6c757d;margin-top:10px;padding-top:8px;border-top:1px solid ' + colors.tooltipBorder + ';text-align:center;">';
    html += '<span style="background:#326ce5;color:#fff;padding:2px 8px;border-radius:4px;cursor:pointer;">üîó Click for details</span>';
    html += '</div>';
    html += '</div>';
    
    tooltip.innerHTML = html;
    tooltip.style.display = 'block';
    moveTooltip(evt);
}

function moveTooltip(evt) {
    var wrapper = document.getElementById('flux-graph-wrapper');
    var wrapperRect = wrapper.getBoundingClientRect();
    var renderedPos = evt.target.renderedPosition();
    
    // Position relative to the wrapper container
    var x = renderedPos.x + 20;
    var y = renderedPos.y - 10;
    
    // Get tooltip dimensions after content is set
    var tooltipRect = tooltip.getBoundingClientRect();
    var tooltipWidth = tooltipRect.width || 300;
    var tooltipHeight = tooltipRect.height || 150;
    
    // Keep tooltip within the graph wrapper bounds
    if (x + tooltipWidth > wrapperRect.width - 10) {
        x = renderedPos.x - tooltipWidth - 20;
    }
    if (x < 10) x = 10;
    
    if (y + tooltipHeight > wrapperRect.height - 10) {
        y = wrapperRect.height - tooltipHeight - 10;
    }
    if (y < 10) y = 10;
    
    tooltip.style.left = x + 'px';
    tooltip.style.top = y + 'px';
}

function hideTooltip() {
    if (tooltip) {
        tooltip.style.display = 'none';
    }
}

function fitGraph() {
    if (cy) cy.fit(30);
}

function resetLayout() {
    if (cy) {
        cy.layout({
            name: 'dagre',
            rankDir: 'LR',
            nodeSep: 60,
            rankSep: 100,
            padding: 20
        }).run();
        cy.fit(30);
    }
}
</script>
