{% extends "base2.html.j2" %}

{% block topmenu %}
<ul class="header-nav d-lg-flex m-3">
    <div class="container-fluid px-4">
      <nav aria-label="breadcrumb">
        <ol class="breadcrumb my-0">
          <li class="breadcrumb-item"><span>Dashboard</span></li>
          <li class="breadcrumb-item active"><span>Workload Map</span></li>
        </ol>
      </nav>
    </div>
</ul>
<ul class="header-nav ms-auto"></ul>
<ul class="header-nav d-lg-flex">
{% include "segments/topmenu.html.j2" %}
{% endblock %}


{% block content %}
<div class="card">
    <div id="filter-menu" class="card-header">
        <div class="row g-2 align-items-center">
            <div class="col-md-3">
                <select class="form-select" aria-label="Select network item" onchange="updateFilter(value, 'item')" id="select-item" >
                    <option value="">Select a network item</option>
                    <option value="edge">edge</option>
                    <option value="node">node</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" aria-label="Select property" onchange="updateFilter(value, 'property')" id="select-property" >
                    <option value="">Select a property...</option>
                </select>
            </div>
            <div class="col-md-3">
                <select class="form-select" aria-label="Select value" id="select-value" >
                    <option value="">Select value(s)...</option>
                </select>
            </div>
            <div class="col-md-1">
              <button type="button" class="btn btn-primary w-100" onclick="highlightFilter(filter);">Filter</button>
            </div>
            <div class="col-md-2">
              <button type="button" class="btn btn-outline-secondary w-100" onclick="clearFilter(true)">Reset</button>
            </div>
        </div>
    </div>
    <div id="network-wrapper" style="position: relative;">
        <div id="mynetwork" class="card-body" style="min-height: 600px; height: calc(100vh - 320px);"></div>
        <!-- Node Tooltip -->
        <div id="node-tooltip" style="display: none; position: absolute; z-index: 1000; max-width: 350px; pointer-events: none;"></div>
    </div>
    <!-- Legend -->
    <div class="card-footer">
        <div class="d-flex flex-wrap align-items-center gap-3">
            <small class="text-muted">
                <strong>Legend:</strong>
                <span class="ms-2"><img src="{{ url_for('static',filename='/img/ds.svg') }}" style="width:18px;height:18px;vertical-align:middle;"> Deployment</span>
                <span class="ms-2"><img src="{{ url_for('static',filename='/img/ds.svg') }}" style="width:18px;height:18px;vertical-align:middle;"> DaemonSet</span>
                <span class="ms-2"><img src="{{ url_for('static',filename='/img/sts.svg') }}" style="width:18px;height:18px;vertical-align:middle;"> StatefulSet</span>
                <span class="ms-2"><img src="{{ url_for('static',filename='/img/rs.svg') }}" style="width:18px;height:18px;vertical-align:middle;"> ReplicaSet</span>
            </small>
            <small class="text-muted border-start ps-3">
                <i class="fa fa-mouse-pointer"></i> <strong>Hover</strong> for info | <i class="fa fa-hand-pointer"></i> <strong>Click</strong> to view details
            </small>
        </div>
    </div>
</div>
{% endblock %}

{% block add_head_css %}
{% include "segments/pyvis_snippet.html.j2" %}
{% endblock %}


{% block add_tail_js %}
    <script>
        function getThemeColor() {
            return document.documentElement.getAttribute('data-coreui-theme') === 'dark' ? '#181a1b' : '#ffffff';
        }

        function updateNetworkTheme() {
            let isDark = document.documentElement.getAttribute('data-coreui-theme') === 'dark';
            let bgColor = isDark ? '#181a1b' : '#ffffff';
            let textColor = isDark ? '#ffffff' : '#343a40';
            let edgeColor = isDark ? '#6c757d' : '#adb5bd';

            // Change Pyvis background
            let networkEl = document.getElementById('mynetwork');
            if (networkEl) {
                networkEl.style.backgroundColor = bgColor;
            }

            // Update network node font colors if network exists
            if (typeof network !== 'undefined' && network !== null) {
                network.setOptions({
                    nodes: {
                        font: {
                            color: textColor,
                            strokeColor: bgColor
                        }
                    },
                    edges: {
                        color: {
                            color: edgeColor,
                            highlight: "#326ce5",
                            hover: "#326ce5"
                        }
                    }
                });
            }

            // Change tooltip and control styling
            let styleId = 'workload-map-theme-style';
            let existingStyle = document.getElementById(styleId);
            if (existingStyle) {
                existingStyle.remove();
            }

            let style = document.createElement('style');
            style.id = styleId;
            style.innerHTML = `
                .vis-tooltip {
                    color: #ffffff !important;
                    background-color: rgba(0, 0, 0, 0.85) !important;
                    border: 1px solid #326ce5 !important;
                    border-radius: 4px !important;
                    padding: 8px 12px !important;
                    font-size: 12px !important;
                }
                /* Fix the select object (.ts-control) in dark mode */
                .ts-control {
                    background-color: ${bgColor} !important;
                    color: ${textColor} !important;
                    border: 1px solid ${isDark ? '#495057' : '#ced4da'} !important;
                }
                .ts-control input {
                    background-color: ${bgColor} !important;
                    color: ${textColor} !important;
                }
                /* Fix .data-selectable elements in dark mode */
                .ts-dropdown {
                    background-color: ${bgColor} !important;
                    border: 1px solid ${isDark ? '#495057' : '#ced4da'} !important;
                }
                .ts-dropdown [data-selectable].option {
                    background-color: ${bgColor} !important;
                    color: ${textColor} !important;
                }
                .ts-dropdown [data-selectable].option:hover,
                .ts-dropdown [data-selectable].option.active {
                    background-color: ${isDark ? '#495057' : '#e9ecef'} !important;
                    color: ${textColor} !important;
                }
                /* Navigation buttons styling - complete override */
                div.vis-network div.vis-navigation div.vis-button {
                    width: 34px !important;
                    height: 34px !important;
                    background-color: ${isDark ? '#212529' : '#ffffff'} !important;
                    border: 1px solid ${isDark ? '#495057' : '#dee2e6'} !important;
                    border-radius: 6px !important;
                    background-image: none !important;
                    box-shadow: 0 1px 3px rgba(0,0,0,0.1) !important;
                    cursor: pointer !important;
                }
                div.vis-network div.vis-navigation div.vis-button:hover {
                    background-color: ${isDark ? '#343a40' : '#f8f9fa'} !important;
                    border-color: #326ce5 !important;
                }
                div.vis-network div.vis-navigation div.vis-button:active {
                    background-color: ${isDark ? '#495057' : '#e9ecef'} !important;
                }
                /* Custom arrow icons using CSS */
                div.vis-button.vis-up:before,
                div.vis-button.vis-down:before,
                div.vis-button.vis-left:before,
                div.vis-button.vis-right:before,
                div.vis-button.vis-zoomIn:before,
                div.vis-button.vis-zoomOut:before,
                div.vis-button.vis-zoomExtends:before {
                    display: flex !important;
                    align-items: center !important;
                    justify-content: center !important;
                    width: 100% !important;
                    height: 100% !important;
                    font-size: 16px !important;
                    font-weight: bold !important;
                    color: ${isDark ? '#adb5bd' : '#495057'} !important;
                    font-family: Arial, sans-serif !important;
                }
                div.vis-button.vis-up:before { content: 'â–²' !important; }
                div.vis-button.vis-down:before { content: 'â–¼' !important; }
                div.vis-button.vis-left:before { content: 'â—€' !important; }
                div.vis-button.vis-right:before { content: 'â–¶' !important; }
                div.vis-button.vis-zoomIn:before { content: '+' !important; font-size: 20px !important; }
                div.vis-button.vis-zoomOut:before { content: 'âˆ’' !important; font-size: 20px !important; }
                div.vis-button.vis-zoomExtends:before { content: 'â¤¢' !important; font-size: 18px !important; }
                div.vis-button:hover:before {
                    color: #326ce5 !important;
                }
            `;
            document.head.appendChild(style);
        }

        const observer = new MutationObserver(() => updateNetworkTheme());
        observer.observe(document.documentElement, { attributes: true, attributeFilter: ['data-coreui-theme'] });

        window.onload = updateNetworkTheme;
    </script>

    <script type="text/javascript">
        // initialize global variables.
        var edges;
        var nodes;
        var allNodes;
        var allEdges;
        var nodeColors;
        var originalNodes;
        var network;
        var container;
        var options, data;
        var filter = {
            item : '',
            property : '',
            value : []
        };

        // explicitly using onItemAdd and this function as we need to save multiple values
        let updateValueFilter = function() {
            return function () {
            filter['value'].push(arguments[0])
            }
        }

        let valueControl = new TomSelect("#select-value",{
            maxItems: null,
            valueField: 'id',
            labelField: 'title',
            searchField: 'title',
            create: false,
            sortField: {
                field: "text",
                direction: "asc"
            },
            onItemAdd: updateValueFilter()
        });

        let addValues = function() {
            return function () {
                // clear the current value options and add the selected attribute values
                // tom-select handles duplicates
                let selectedProperty = arguments[0];
                valueControl.clear();
                valueControl.clearOptions();
                filter['value'] = []
                if (filter['item'] === 'node') {
                    for (let each in allNodes) {
                        valueControl.addOption({
                            id:allNodes[each][selectedProperty],
                            title:allNodes[each][selectedProperty]
                        })
                    }
                }
                else if (filter['item'] === 'edge') {
                    for (let each in allEdges) {
                        valueControl.addOption({
                            id:allEdges[each][selectedProperty],
                            title:allEdges[each][selectedProperty]
                        })
                    }
                }
            }
        };

        let propControl = new TomSelect("#select-property",{
            valueField: 'id',
            labelField: 'title',
            searchField: 'title',
            create: false,
            sortField: {
                field: "text",
                direction: "asc"
            },
            onItemAdd: addValues()
        });

        let addProperties = function() {
            return function () {
                // loops through the selected network item and adds the attributes to dropdown
                // tom-select handles duplicates
                clearFilter(false)
                if (arguments[0] === 'edge') {
                    for (let each in allEdges) {
                        if (allEdges.hasOwnProperty(each)) {
                            for (let eachProp in allEdges[each]) {
                                if (allEdges[each].hasOwnProperty(eachProp)) {
                                    propControl.addOption({id: eachProp, title: eachProp})
                                }
                            }
                        }
                    }
                }
                else if (arguments[0] === 'node') {
                    for (let each in allNodes) {
                        if (allNodes.hasOwnProperty(each)) {
                            for (let eachProp in allNodes[each]) {
                                if (allNodes[each].hasOwnProperty(eachProp)
                                    && (eachProp !== 'hidden' && eachProp !== 'savedLabel'
                                        && eachProp !== 'hiddenLabel')) {
                                    propControl.addOption({id: eachProp, title: eachProp})

                                }
                            }
                        }
                    }
                }
            }
        };

        let itemControl = new TomSelect("#select-item",{
            create: false,
            sortField:{
                field: "text",
                direction: "asc"
            },
            onItemAdd: addProperties()
        });

        function clearFilter(reset) {
            // utility function to clear all the selected filter options
            // if reset is set to true, the existing filter will be removed
            // else, only the dropdown options are cleared
            propControl.clear();
            propControl.clearOptions();
            valueControl.clear();
            valueControl.clearOptions();
            filter = {
                item : '',
                property : '',
                value : []
            }
            if (reset) {
                itemControl.clear();
                filterHighlight({nodes: []})
            }
        }

        function updateFilter(value, key) {
            // key could be 'item' or 'property' and value is as selected in dropdown
            filter[key] = value
        }

        // This method is responsible for drawing the graph, returns the drawn network
        function drawGraph() {
            var container = document.getElementById('mynetwork');
            let node = JSON.parse('{{ nodes | tojson }}');
            let edge = JSON.parse('{{ edges | tojson }}');

            // parsing and collecting nodes and edges from the python
            nodes = new vis.DataSet(node);
            edges = new vis.DataSet(edge);

            nodeColors = {};
            allNodes = nodes.get({ returnType: "Object" });
            for (nodeId in allNodes) {
                nodeColors[nodeId] = allNodes[nodeId].color;
            }
            allEdges = edges.get({ returnType: "Object" });
            // adding nodes and edges to the graph
            data = {nodes: nodes, edges: edges};

            // Detect dark mode for font colors
            let isDark = document.documentElement.getAttribute('data-coreui-theme') === 'dark';
            let fontColor = isDark ? '#ffffff' : '#343a40';
            let edgeColor = isDark ? '#6c757d' : '#adb5bd';

            var options = {
                "configure": {
                    "enabled": false
                },
                "edges": {
                    "color": {
                        "color": edgeColor,
                        "highlight": "#326ce5",
                        "hover": "#326ce5"
                    },
                    "smooth": {
                        "enabled": true,
                        "type": "dynamic"
                    },
                    "arrows": {
                        "to": {
                            "enabled": true,
                            "scaleFactor": 0.5
                        }
                    },
                    "width": 1.5
                },
                "nodes": {
                    "font": {
                        "color": fontColor,
                        "size": 12,
                        "face": "Arial, sans-serif",
                        "strokeWidth": 0,
                        "strokeColor": isDark ? "#181a1b" : "#ffffff"
                    }
                },
                "groups": {
                    "daemonset": {
                        "image": {
                            "unselected": "{{ url_for('static',filename='/img/ds.svg') }}"
                        },
                        "level": 2,
                        "shape": "image"
                    },
                    "deployment": {
                        "image": {
                            "unselected": "{{ url_for('static',filename='/img/ds.svg') }}"
                        },
                        "level": 1,
                        "shape": "image"
                    },
                    "pod": {
                        "image": {
                            "unselected": "{{ url_for('static',filename='/img/pod.svg') }}"
                        },
                        "level": 3,
                        "shape": "image"
                    },
                    "replicaset": {
                        "image": {
                            "unselected": "{{ url_for('static',filename='/img/rs.svg') }}"
                        },
                        "level": 2,
                        "shape": "image"
                    },
                    "statefulset": {
                        "image": {
                            "unselected": "{{ url_for('static',filename='/img/sts.svg') }}"
                        },
                        "level": 2,
                        "shape": "image"
                    }
                },
                "interaction": {
                    "zoomView": true,
                    "zoomSpeed": 0.5,
                    "dragNodes": true,
                    "hideEdgesOnDrag": false,
                    "hideNodesOnDrag": false,
                    "navigationButtons": true,
                    "hover": true,
                    "tooltipDelay": 200
                },
                "layout": {
                    "hierarchical": {
                        "blockShifting": true,
                        "edgeMinimization": true,
                        "enabled": true,
                        "direction": "UD",
                        "levelSeparation": 120,
                        "nodeSpacing": 150,
                        "parentCentralization": true,
                        "sortMethod": "directed",
                        "treeSpacing": 200
                    },
                    "improvedLayout": true,
                    "randomSeed": 0
                },
                "physics": {
                    "enabled": false,
                    "hierarchicalRepulsion": {
                        "centralGravity": 0.0,
                        "springLength": 100,
                        "springConstant": 0.01,
                        "nodeDistance": 150
                    },
                    "stabilization": {
                        "enabled": true,
                        "fit": true,
                        "iterations": 1000,
                        "onlyDynamicEdges": false,
                        "updateInterval": 50
                    }
                }
            };

            // if this network requires displaying the configure window,
            // put it in its div
            // options.configure["container"] = document.getElementById("config");
            network = new vis.Network(container, data, options);

            // Apply theme after network is created
            setTimeout(updateNetworkTheme, 100);

            // Add click handler for navigation
            network.on('click', function(params) {
                if (params.nodes.length > 0) {
                    let nodeId = params.nodes[0];
                    let nodeData = nodes.get(nodeId);
                    if (nodeData && nodeData.kind) {
                        // Map kind to route path
                        let kindRoutes = {
                            'Deployment': '/workload/deployments',
                            'DaemonSet': '/workload/daemonsets',
                            'StatefulSet': '/workload/statefulsets',
                            'ReplicaSet': '/workload/replicasets'
                        };
                        let route = kindRoutes[nodeData.kind];
                        if (route) {
                            window.location.href = route;
                        }
                    }
                }
            });

            // Add hover handlers for tooltip
            network.on('hoverNode', function(params) {
                document.body.style.cursor = 'pointer';
                showNodeTooltip(params.node);
            });

            network.on('blurNode', function(params) {
                document.body.style.cursor = 'default';
                hideNodeTooltip();
            });

            // Update tooltip position on mouse move
            container.addEventListener('mousemove', function(evt) {
                moveNodeTooltip(evt);
            });

            return network;
        }

        // Tooltip functions
        var tooltip = null;
        
        function showNodeTooltip(nodeId) {
            tooltip = document.getElementById('node-tooltip');
            if (!tooltip) return;
            
            let nodeData = nodes.get(nodeId);
            if (!nodeData) return;
            
            let isDark = document.documentElement.getAttribute('data-coreui-theme') === 'dark';
            let bgColor = isDark ? '#2d2d2d' : '#ffffff';
            let textColor = isDark ? '#e4e4e4' : '#212529';
            let borderColor = isDark ? '#444' : '#dee2e6';
            let codeBg = isDark ? '#333' : '#f1f3f5';
            
            // Determine status based on ready/desired
            let statusBadge = '';
            let ready = nodeData.ready || 0;
            let desired = nodeData.desired || 0;
            if (ready >= desired && desired > 0) {
                statusBadge = '<span style="background:#198754;color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;">âœ“ Ready ' + ready + '/' + desired + '</span>';
            } else if (ready > 0) {
                statusBadge = '<span style="background:#ffc107;color:#000;padding:2px 8px;border-radius:4px;font-size:11px;">âš  Partial ' + ready + '/' + desired + '</span>';
            } else {
                statusBadge = '<span style="background:#dc3545;color:#fff;padding:2px 8px;border-radius:4px;font-size:11px;">âœ— Not Ready ' + ready + '/' + desired + '</span>';
            }
            
            // Kind color mapping
            let kindColors = {
                'Deployment': '#326ce5',
                'DaemonSet': '#326ce5',
                'StatefulSet': '#326ce5',
                'ReplicaSet': '#6c757d'
            };
            let kindColor = kindColors[nodeData.kind] || '#6c757d';
            
            let html = '<div style="background:' + bgColor + ';border:1px solid ' + borderColor + ';border-radius:8px;padding:12px 14px;box-shadow:0 4px 16px rgba(0,0,0,0.2);color:' + textColor + ';min-width:260px;">';
            
            // Header with kind badge
            html += '<div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;padding-bottom:8px;border-bottom:1px solid ' + borderColor + ';">';
            html += '<span style="background:' + kindColor + ';color:#fff;padding:2px 8px;border-radius:4px;font-size:10px;text-transform:uppercase;">' + (nodeData.kind || nodeData.group || '-') + '</span>';
            html += '<span style="font-weight:bold;font-size:14px;">' + (nodeData.label || nodeId) + '</span>';
            html += '</div>';
            
            html += '<table style="font-size:12px;width:100%;border-collapse:collapse;">';
            html += '<tr><td style="padding:3px 10px 3px 0;color:#6c757d;width:80px;">Namespace:</td><td style="padding:3px 0;"><code style="background:' + codeBg + ';padding:1px 4px;border-radius:3px;font-size:11px;">' + (nodeData.namespace || '-') + '</code></td></tr>';
            html += '<tr><td style="padding:3px 10px 3px 0;color:#6c757d;">Status:</td><td style="padding:3px 0;">' + statusBadge + '</td></tr>';
            
            // Show available if present
            if (nodeData.available !== undefined) {
                html += '<tr><td style="padding:3px 10px 3px 0;color:#6c757d;">Available:</td><td style="padding:3px 0;">' + nodeData.available + '</td></tr>';
            }
            
            // Show age if present
            if (nodeData.age) {
                html += '<tr><td style="padding:3px 10px 3px 0;color:#6c757d;">Age:</td><td style="padding:3px 0;">' + nodeData.age + '</td></tr>';
            }
            
            // Show container image for deployments
            if (nodeData.containerImage) {
                let img = nodeData.containerImage.length > 40 ? nodeData.containerImage.substring(0, 40) + '...' : nodeData.containerImage;
                html += '<tr><td style="padding:3px 10px 3px 0;color:#6c757d;vertical-align:top;">Image:</td><td style="padding:3px 0;font-size:11px;word-break:break-all;">' + img + '</td></tr>';
            }
            
            // Show owner for replicasets
            if (nodeData.owner) {
                html += '<tr><td style="padding:3px 10px 3px 0;color:#6c757d;">Owner:</td><td style="padding:3px 0;font-size:11px;">' + nodeData.owner + '</td></tr>';
            }
            
            html += '</table>';
            
            // Click hint
            html += '<div style="font-size:10px;color:#6c757d;margin-top:10px;padding-top:8px;border-top:1px solid ' + borderColor + ';text-align:center;">';
            html += '<span style="background:#326ce5;color:#fff;padding:2px 8px;border-radius:4px;">ðŸ”— Click to view ' + (nodeData.kind || 'workload') + 's</span>';
            html += '</div>';
            html += '</div>';
            
            tooltip.innerHTML = html;
            tooltip.style.display = 'block';
        }
        
        function moveNodeTooltip(evt) {
            if (!tooltip || tooltip.style.display === 'none') return;
            
            let wrapper = document.getElementById('network-wrapper');
            if (!wrapper) return;
            
            let wrapperRect = wrapper.getBoundingClientRect();
            let x = evt.clientX - wrapperRect.left + 15;
            let y = evt.clientY - wrapperRect.top + 15;
            
            // Keep tooltip within bounds
            let tooltipRect = tooltip.getBoundingClientRect();
            let tooltipWidth = tooltipRect.width || 300;
            let tooltipHeight = tooltipRect.height || 200;
            
            if (x + tooltipWidth > wrapperRect.width - 10) {
                x = evt.clientX - wrapperRect.left - tooltipWidth - 15;
            }
            if (y + tooltipHeight > wrapperRect.height - 10) {
                y = wrapperRect.height - tooltipHeight - 10;
            }
            if (x < 10) x = 10;
            if (y < 10) y = 10;
            
            tooltip.style.left = x + 'px';
            tooltip.style.top = y + 'px';
        }
        
        function hideNodeTooltip() {
            if (tooltip) {
                tooltip.style.display = 'none';
            }
        }

        drawGraph();
    </script>
{% endblock %}